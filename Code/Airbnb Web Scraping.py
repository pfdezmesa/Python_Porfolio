
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "1cf24d0c-49be-4b87-a921-12d6e2b2b528",
   "metadata": {},
   "outputs": [],
   "source": [
    "#LIBRARY\n",
    "\n",
    "from time import sleep\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.chrome.service import Service\n",
    "from selenium.common.exceptions import NoSuchElementException\n",
    "from selenium.webdriver.common.keys import Keys\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "from webdriver_manager.chrome import ChromeDriverManager\n",
    "import pandas as pd\n",
    "import time\n",
    "import re\n",
    "from sqlalchemy import create_engine\n",
    "import mysql.connector"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "e9e0a3e0-39c1-482d-a117-c1bf8f88404b",
   "metadata": {},
   "outputs": [],
   "source": [
    "#CREATE WEBDRIVER\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"user-agent=Chrome/115.0.5790.102\")\n",
    "opts.add_argument(\"--headless\")\n",
    "opts.add_argument(\"--disable-gpu\")  # Deshabilitar GPU en modo headless\n",
    "opts.add_argument(\"--window-size=1920x1080\")  # Tamaño de ventana en modo headless\n",
    "\n",
    "driver = webdriver.Chrome(\n",
    "    service=Service(executable_path=\"C:/Users/Pc/AppData/Local/binman/binman_chromedriver/win32/115.0.5790.102/chromedriver.exe\"),\n",
    "    options=opts\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "18104a7c-68f4-467a-b2a4-4c92af54340a",
   "metadata": {
    "collapsed": true,
    "jupyter": {
     "outputs_hidden": true
    },
    "tags": []
   },
   "outputs": [
    {
     "ename": "NoSuchElementException",
     "evalue": "Message: no such element: Unable to locate element: {\"method\":\"xpath\",\"selector\":\"/html/body/div[5]/div/div/div[1]/div/div[4]/section/div[2]/div[2]/button\"}\n  (Session info: headless chrome=116.0.5845.97); For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors#no-such-element-exception\nStacktrace:\nBacktrace:\n\tGetHandleVerifier [0x00DF1C53+49427]\n\t(No symbol) [0x00D85F41]\n\t(No symbol) [0x00C8C64D]\n\t(No symbol) [0x00CB9818]\n\t(No symbol) [0x00CB98DB]\n\t(No symbol) [0x00CE87D2]\n\t(No symbol) [0x00CD4A64]\n\t(No symbol) [0x00CE6F2A]\n\t(No symbol) [0x00CD4816]\n\t(No symbol) [0x00CB1127]\n\t(No symbol) [0x00CB22AD]\n\tGetHandleVerifier [0x01047149+2496009]\n\tGetHandleVerifier [0x0108D572+2783794]\n\tGetHandleVerifier [0x01087491+2758993]\n\tGetHandleVerifier [0x00E711D0+571024]\n\t(No symbol) [0x00D8F96A]\n\t(No symbol) [0x00D8BD88]\n\t(No symbol) [0x00D8BE6B]\n\t(No symbol) [0x00D7EA97]\n\tBaseThreadInitThunk [0x76D700C9+25]\n\tRtlGetAppContainerNamedObjectPath [0x77D17B1E+286]\n\tRtlGetAppContainerNamedObjectPath [0x77D17AEE+238]\n",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mNoSuchElementException\u001b[0m                    Traceback (most recent call last)",
      "\u001b[1;32mC:\\Users\\Public\\Documents\\Wondershare\\CreatorTemp\\ipykernel_2964\\222051375.py\u001b[0m in \u001b[0;36m<module>\u001b[1;34m\u001b[0m\n\u001b[0;32m      5\u001b[0m \u001b[0mtime\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0msleep\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;36m10\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m      6\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m----> 7\u001b[1;33m \u001b[0mdriver\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mfind_element\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mBy\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mXPATH\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;34m\"/html/body/div[5]/div/div/div[1]/div/div[4]/section/div[2]/div[2]/button\"\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mclick\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m",
      "\u001b[1;32m~\\anaconda3\\lib\\site-packages\\selenium\\webdriver\\remote\\webdriver.py\u001b[0m in \u001b[0;36mfind_element\u001b[1;34m(self, by, value)\u001b[0m\n\u001b[0;32m    738\u001b[0m             \u001b[0mvalue\u001b[0m \u001b[1;33m=\u001b[0m \u001b[1;34mf'[name=\"{value}\"]'\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    739\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m--> 740\u001b[1;33m         \u001b[1;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mexecute\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mCommand\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mFIND_ELEMENT\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;33m{\u001b[0m\u001b[1;34m\"using\"\u001b[0m\u001b[1;33m:\u001b[0m \u001b[0mby\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;34m\"value\"\u001b[0m\u001b[1;33m:\u001b[0m \u001b[0mvalue\u001b[0m\u001b[1;33m}\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;34m\"value\"\u001b[0m\u001b[1;33m]\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m\u001b[0;32m    741\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    742\u001b[0m     \u001b[1;32mdef\u001b[0m \u001b[0mfind_elements\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mself\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mby\u001b[0m\u001b[1;33m=\u001b[0m\u001b[0mBy\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mID\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mvalue\u001b[0m\u001b[1;33m:\u001b[0m \u001b[0mOptional\u001b[0m\u001b[1;33m[\u001b[0m\u001b[0mstr\u001b[0m\u001b[1;33m]\u001b[0m \u001b[1;33m=\u001b[0m \u001b[1;32mNone\u001b[0m\u001b[1;33m)\u001b[0m \u001b[1;33m->\u001b[0m \u001b[0mList\u001b[0m\u001b[1;33m[\u001b[0m\u001b[0mWebElement\u001b[0m\u001b[1;33m]\u001b[0m\u001b[1;33m:\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n",
      "\u001b[1;32m~\\anaconda3\\lib\\site-packages\\selenium\\webdriver\\remote\\webdriver.py\u001b[0m in \u001b[0;36mexecute\u001b[1;34m(self, driver_command, params)\u001b[0m\n\u001b[0;32m    344\u001b[0m         \u001b[0mresponse\u001b[0m \u001b[1;33m=\u001b[0m \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mcommand_executor\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mexecute\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mdriver_command\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mparams\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    345\u001b[0m         \u001b[1;32mif\u001b[0m \u001b[0mresponse\u001b[0m\u001b[1;33m:\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m--> 346\u001b[1;33m             \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0merror_handler\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mcheck_response\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mresponse\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m\u001b[0;32m    347\u001b[0m             \u001b[0mresponse\u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;34m\"value\"\u001b[0m\u001b[1;33m]\u001b[0m \u001b[1;33m=\u001b[0m \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0m_unwrap_value\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mresponse\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mget\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;34m\"value\"\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;32mNone\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    348\u001b[0m             \u001b[1;32mreturn\u001b[0m \u001b[0mresponse\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n",
      "\u001b[1;32m~\\anaconda3\\lib\\site-packages\\selenium\\webdriver\\remote\\errorhandler.py\u001b[0m in \u001b[0;36mcheck_response\u001b[1;34m(self, response)\u001b[0m\n\u001b[0;32m    243\u001b[0m                 \u001b[0malert_text\u001b[0m \u001b[1;33m=\u001b[0m \u001b[0mvalue\u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;34m\"alert\"\u001b[0m\u001b[1;33m]\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mget\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;34m\"text\"\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    244\u001b[0m             \u001b[1;32mraise\u001b[0m \u001b[0mexception_class\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mmessage\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mscreen\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mstacktrace\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0malert_text\u001b[0m\u001b[1;33m)\u001b[0m  \u001b[1;31m# type: ignore[call-arg]  # mypy is not smart enough here\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m--> 245\u001b[1;33m         \u001b[1;32mraise\u001b[0m \u001b[0mexception_class\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mmessage\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mscreen\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mstacktrace\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m",
      "\u001b[1;31mNoSuchElementException\u001b[0m: Message: no such element: Unable to locate element: {\"method\":\"xpath\",\"selector\":\"/html/body/div[5]/div/div/div[1]/div/div[4]/section/div[2]/div[2]/button\"}\n  (Session info: headless chrome=116.0.5845.97); For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors#no-such-element-exception\nStacktrace:\nBacktrace:\n\tGetHandleVerifier [0x00DF1C53+49427]\n\t(No symbol) [0x00D85F41]\n\t(No symbol) [0x00C8C64D]\n\t(No symbol) [0x00CB9818]\n\t(No symbol) [0x00CB98DB]\n\t(No symbol) [0x00CE87D2]\n\t(No symbol) [0x00CD4A64]\n\t(No symbol) [0x00CE6F2A]\n\t(No symbol) [0x00CD4816]\n\t(No symbol) [0x00CB1127]\n\t(No symbol) [0x00CB22AD]\n\tGetHandleVerifier [0x01047149+2496009]\n\tGetHandleVerifier [0x0108D572+2783794]\n\tGetHandleVerifier [0x01087491+2758993]\n\tGetHandleVerifier [0x00E711D0+571024]\n\t(No symbol) [0x00D8F96A]\n\t(No symbol) [0x00D8BD88]\n\t(No symbol) [0x00D8BE6B]\n\t(No symbol) [0x00D7EA97]\n\tBaseThreadInitThunk [0x76D700C9+25]\n\tRtlGetAppContainerNamedObjectPath [0x77D17B1E+286]\n\tRtlGetAppContainerNamedObjectPath [0x77D17AEE+238]\n"
     ]
    }
   ],
   "source": [
    "#COOKIES\n",
    "\n",
    "driver.get('https://www.airbnb.com/s/Granada/homes?tab_id=home_tab&refinement_paths%5B%5D=%2Fhomes&flexible_trip_lengths%5B%5D=one_week&monthly_start_date=2023-08-01&monthly_length=3&price_filter_input_type=0&price_filter_num_nights=5&channel=EXPLORE&query=Granada&place_id=ChIJfcIyLeb8cQ0Rcg1g0533WJI&date_picker_type=flexible_dates&source=structured_search_input_header&search_type=autocomplete_click&federated_search_session_id=89910c07-470f-4031-821d-b0d5c036912f&pagination_search=true&cursor=eyJzZWN0aW9uX29mZnNldCI6MywiaXRlbXNfb2Zmc2V0IjoxOCwidmVyc2lvbiI6MX0%3D')\n",
    "\n",
    "time.sleep(10)\n",
    "\n",
    "driver.find_element(By.XPATH, \"/html/body/div[5]/div/div/div[1]/div/div[4]/section/div[2]/div[2]/button\").click()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 142,
   "id": "b6f43db6-ecbd-42a5-8631-9e16250bd013",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>url</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>298</th>\n",
       "      <td>https://www.airbnb.com/s/Baza/homes?date_picke...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>299</th>\n",
       "      <td>https://www.airbnb.com/s/Baza/homes?date_picke...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>300</th>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>301</th>\n",
       "      <td>https://www.airbnb.com/s/Motril/homes?date_pic...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>302</th>\n",
       "      <td>https://www.airbnb.com/s/Baza/homes?date_picke...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>303 rows × 1 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                   url\n",
       "0    https://www.airbnb.com/s/Granada/homes?date_pi...\n",
       "1    https://www.airbnb.com/s/Granada/homes?date_pi...\n",
       "2    https://www.airbnb.com/s/Granada/homes?date_pi...\n",
       "3    https://www.airbnb.com/s/Granada/homes?date_pi...\n",
       "4    https://www.airbnb.com/s/Granada/homes?date_pi...\n",
       "..                                                 ...\n",
       "298  https://www.airbnb.com/s/Baza/homes?date_picke...\n",
       "299  https://www.airbnb.com/s/Baza/homes?date_picke...\n",
       "300  https://www.airbnb.com/s/Granada/homes?date_pi...\n",
       "301  https://www.airbnb.com/s/Motril/homes?date_pic...\n",
       "302  https://www.airbnb.com/s/Baza/homes?date_picke...\n",
       "\n",
       "[303 rows x 1 columns]"
      ]
     },
     "execution_count": 142,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#CREATE SEARCH RANGE\n",
    "\n",
    "url_range_min = list(range(1, 1001, 10))\n",
    "url_range_max = list(range(10, 1010, 10))\n",
    "localizacion_list = [\"Granada\", \"Motril\", \"Baza\"]\n",
    "\n",
    "urls = []\n",
    "\n",
    "for localizacion in localizacion_list:\n",
    "    for min_val, max_val in zip(url_range_min, url_range_max):\n",
    "        url = f\"https://www.airbnb.com/s/{localizacion}/homes?date_picker_type=flexible_dates&price_max={max_val}&price_min={min_val}\"\n",
    "        urls.append(url)\n",
    "        \n",
    "special_url = [f\"https://www.airbnb.com/s/{localizacion}/homes?date_picker_type=flexible_dates&price_min=1000\" for localizacion in localizacion_list]\n",
    "\n",
    "urls = urls + special_url\n",
    "\n",
    "data = {\"url\": urls}\n",
    "df = pd.DataFrame(data)\n",
    "\n",
    "df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 153,
   "id": "4bcbdd4e-3b89-419e-b505-3abf875ff26e",
   "metadata": {},
   "outputs": [],
   "source": [
    "#FUNCTION FOR FIRTS SCRAPING: LINK\n",
    "\n",
    "def extraer_link(url):\n",
    "    \n",
    "    df_link = pd.DataFrame(columns=[\"link\", \"url_general\", \"id_room\"])\n",
    "\n",
    "    try:\n",
    "        driver.get(url)\n",
    "        time.sleep(5)\n",
    "        \n",
    "        data = []\n",
    "        elements = driver.find_elements(By.CSS_SELECTOR, \"a.l1ovpqvx.bn2bl2p.dir.dir-ltr\")\n",
    "        for element in elements:\n",
    "            data.append({\"link\": element.get_attribute(\"href\"),\n",
    "                                 \"url_general\": url,\n",
    "                                 \"id_room\": int(re.search(r'/rooms/(\\d+)', element.get_attribute(\"href\")).group(1))})\n",
    "        \n",
    "        df_link = pd.concat([df_link, pd.DataFrame(data)])\n",
    "        \n",
    "        try:\n",
    "            vermas = driver.find_element(By.CSS_SELECTOR, \".l1ovpqvx.c1ytbx3a.dir.dir-ltr\")\n",
    "            while vermas.is_displayed():\n",
    "                vermas.click()\n",
    "                time.sleep(5)\n",
    "                \n",
    "                data = []\n",
    "                elements = driver.find_elements(By.CSS_SELECTOR, \"a.l1ovpqvx.bn2bl2p.dir.dir-ltr\")\n",
    "                for element in elements:\n",
    "                    data.append({\"link\": element.get_attribute(\"href\"),\n",
    "                                 \"url_general\": url,\n",
    "                                 \"id_room\": int(re.search(r'/rooms/(\\d+)', element.get_attribute(\"href\")).group(1))})\n",
    "                \n",
    "                df_link = pd.concat([df_link, pd.DataFrame(data)])\n",
    "                time.sleep(5)\n",
    "                \n",
    "        except Exception as e:\n",
    "            pass\n",
    "        \n",
    "        print(\"Ya extrajiste de la pag:\", url)\n",
    "        time.sleep(5)\n",
    "    \n",
    "    except Exception as e:\n",
    "        pass\n",
    "    \n",
    "    return df_link"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 154,
   "id": "343231a1-bc35-4dd6-b184-30b36969f0f3",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ya extrajiste de la pag: https://www.airbnb.com/s/Granada/homes?date_picker_type=flexible_dates&price_max=20&price_min=11\n"
     ]
    }
   ],
   "source": [
    "#FIRTS SCRAPING: lINK\n",
    "\n",
    "df_link = pd.DataFrame()\n",
    "\n",
    "for url in df['url']:\n",
    "    extracted_data = extraer_link(url)\n",
    "    df_link = pd.concat([df_link, extracted_data], ignore_index=True)\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 69,
   "id": "ceb322a9-93f3-41ee-b744-fa35c76a3e4d",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>link</th>\n",
       "      <th>url_general</th>\n",
       "      <th>id_room</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>https://www.airbnb.com/rooms/8100775?adults=1&amp;...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>8.100775e+06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>https://www.airbnb.com/rooms/91304378707757389...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>9.130438e+17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>https://www.airbnb.com/rooms/54755771727677141...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>5.475577e+17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>https://www.airbnb.com/rooms/57228172745073059...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>5.722817e+17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>https://www.airbnb.com/rooms/95304477160974106...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>9.530448e+17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2174</th>\n",
       "      <td>https://www.airbnb.com/rooms/79602643970577745...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>7.960264e+17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2175</th>\n",
       "      <td>https://www.airbnb.com/rooms/8544232?adults=1&amp;...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>8.544232e+06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2176</th>\n",
       "      <td>https://www.airbnb.com/rooms/22880392?adults=1...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>2.288039e+07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2177</th>\n",
       "      <td>https://www.airbnb.com/rooms/30950309?adults=1...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>3.095031e+07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2178</th>\n",
       "      <td>https://www.airbnb.com/rooms/41432686?adults=1...</td>\n",
       "      <td>https://www.airbnb.com/s/Granada/homes?date_pi...</td>\n",
       "      <td>4.143269e+07</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>2179 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                   link  \\\n",
       "0     https://www.airbnb.com/rooms/8100775?adults=1&...   \n",
       "1     https://www.airbnb.com/rooms/91304378707757389...   \n",
       "2     https://www.airbnb.com/rooms/54755771727677141...   \n",
       "3     https://www.airbnb.com/rooms/57228172745073059...   \n",
       "4     https://www.airbnb.com/rooms/95304477160974106...   \n",
       "...                                                 ...   \n",
       "2174  https://www.airbnb.com/rooms/79602643970577745...   \n",
       "2175  https://www.airbnb.com/rooms/8544232?adults=1&...   \n",
       "2176  https://www.airbnb.com/rooms/22880392?adults=1...   \n",
       "2177  https://www.airbnb.com/rooms/30950309?adults=1...   \n",
       "2178  https://www.airbnb.com/rooms/41432686?adults=1...   \n",
       "\n",
       "                                            url_general       id_room  \n",
       "0     https://www.airbnb.com/s/Granada/homes?date_pi...  8.100775e+06  \n",
       "1     https://www.airbnb.com/s/Granada/homes?date_pi...  9.130438e+17  \n",
       "2     https://www.airbnb.com/s/Granada/homes?date_pi...  5.475577e+17  \n",
       "3     https://www.airbnb.com/s/Granada/homes?date_pi...  5.722817e+17  \n",
       "4     https://www.airbnb.com/s/Granada/homes?date_pi...  9.530448e+17  \n",
       "...                                                 ...           ...  \n",
       "2174  https://www.airbnb.com/s/Granada/homes?date_pi...  7.960264e+17  \n",
       "2175  https://www.airbnb.com/s/Granada/homes?date_pi...  8.544232e+06  \n",
       "2176  https://www.airbnb.com/s/Granada/homes?date_pi...  2.288039e+07  \n",
       "2177  https://www.airbnb.com/s/Granada/homes?date_pi...  3.095031e+07  \n",
       "2178  https://www.airbnb.com/s/Granada/homes?date_pi...  4.143269e+07  \n",
       "\n",
       "[2179 rows x 3 columns]"
      ]
     },
     "execution_count": 69,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#DELETE NaN AND DUPLICATE\n",
    "\n",
    "df_link = df_link.dropna(subset=['id_room'])\n",
    "\n",
    "df_link = df_link.drop_duplicates(subset=['id_room'], ignore_index=True)\n",
    "\n",
    "df_link"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 85,
   "id": "eba923a7-c855-429b-b376-5918de79c290",
   "metadata": {},
   "outputs": [],
   "source": [
    "#SAVE DATAFRAME\n",
    "\n",
    "df_link.to_csv(\"C:/Users/Pc/Desktop/df_link.csv\", index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 91,
   "id": "1c5b9c34-a839-4aa8-bcdd-e858c9e2f0ce",
   "metadata": {},
   "outputs": [],
   "source": [
    "#FUNCTION FOR SECOND SCRAPING: ROOM\n",
    "\n",
    "def extraer_datos(url):\n",
    "    \n",
    "    df_room = pd.DataFrame(columns = [\"titulo\",\n",
    "                                      \"localizacion\",\n",
    "                                      \"tipo_alojamiento\",\n",
    "                                      \"capacidad\",\n",
    "                                      \"latitud\",\n",
    "                                      \"longitud\",\n",
    "                                      \"reviews\",\n",
    "                                      \"puntuacion\",\n",
    "                                      \"precio\",\n",
    "                                      \"id_room\",\n",
    "                                      \"id_host\",\n",
    "                                      \"perfil_host\",\n",
    "                                      \"url\",\n",
    "                                      \"fecha_extraccion\"\n",
    "                                     ])\n",
    "     \n",
    "    try:\n",
    "        \n",
    "    #ACCEDER A LA WEB, Y HACER SCROLL DOWN HACIA EL MAPA PARA QUE CARGE CORRECTAMENTE. \n",
    "    \n",
    "        driver.get(url)\n",
    "        \n",
    "        time.sleep(5)\n",
    "        \n",
    "        selector = \"#site-content > div > div:nth-child(1) > div:nth-child(5) > div > div > div > div:nth-child(2) > section > div._384m8u\"\n",
    "\n",
    "        script = f'''\n",
    "            var element = document.querySelector('{selector}');\n",
    "            if (element) {{\n",
    "                element.scrollIntoView({{ behavior: 'smooth' }});\n",
    "            }}\n",
    "        '''\n",
    "\n",
    "        driver.execute_script(script)\n",
    "        \n",
    "        time.sleep(3)\n",
    "        \n",
    "    #NODOS\n",
    "        \n",
    "        nodo_titulo = \"._1n81at5\"\n",
    "    \n",
    "        nodo_localizacion = \"._9xiloll\"\n",
    "\n",
    "        nodo_tipo_alojamiento = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[1]/div/div[1]/div/div/div/div/div[1]/section/h2\"\n",
    "\n",
    "        nodo_tipo_alojamiento2 = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[1]/div/div[1]/div/div/section/div/div/div[1]/div/h2\"\n",
    "\n",
    "        nodo_capacidad = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[1]/div/div[1]/div/div/div/ul/li[1]/div[2]/div\"\n",
    "\n",
    "        nodo_capacidad2 = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[1]/div/div[1]/div/div/section/div/div/div[1]/ol/li[1]/span[1]\"\n",
    "\n",
    "        nodo_reviews = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[4]/div/div/div/div[2]/section/div[1]/span[2]/h2/div/span\"\n",
    "\n",
    "        nodo_reviews2 = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[2]/div/div/div[1]/div/div/div/div/div/div/div/div/div[1]/div[2]/span/span/button/span\"\n",
    "\n",
    "        nodo_precio = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[2]/div/div/div[1]/div/div/div/div/div/div/div/div[1]/div[1]/div/div/span/div/span[1]\"\n",
    "        \n",
    "        nodo_coordenadas = \"#site-content > div > div:nth-child(1) > div:nth-child(5) > div > div > div > div:nth-child(2) > section > div._384m8u > div:nth-child(4) > div > div > div > div:nth-child(15) > div > a\"\n",
    "\n",
    "        nodo_host = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[6]/div/div/div/div[2]/div/section/div[1]/div[1]/div/a\"\n",
    "\n",
    "        nodo_host2 = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[1]/div/div[4]/div/div[2]/section/div[2]/div/div/div[1]/div[2]/a\"\n",
    "\n",
    "        nodo_host3 = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div/div/div/div[1]/main/div/div[1]/div[3]/div/div[1]/div/div[3]/div/div[2]/section/div[2]/div/div/div[1]/div[2]/a\"\n",
    "        \n",
    "    #TITULO\n",
    "        \n",
    "        try:\n",
    "            titulo = driver.find_element(By.CSS_SELECTOR, nodo_titulo).text\n",
    "        except NoSuchElementException:\n",
    "            titulo = None\n",
    "            \n",
    "        \n",
    "    #LOCALIZACION     \n",
    "        \n",
    "        try:\n",
    "            localizacion = driver.find_element(By.CSS_SELECTOR, nodo_localizacion).text\n",
    "        except NoSuchElementException:\n",
    "            titulo = None\n",
    "        \n",
    "    #TIPO_ALOJAMIENTO        \n",
    "        \n",
    "        try:\n",
    "            tipo_alojamiento = driver.find_element(By.XPATH, nodo_tipo_alojamiento).text\n",
    "            tipo_alojamiento = re.sub(\"\\\\..*\", \"\", tipo_alojamiento)\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            try:\n",
    "                tipo_alojamiento = driver.find_element(By.XPATH, nodo_tipo_alojamiento2).text\n",
    "                tipo_alojamiento = re.sub(\"\\\\..*\", \"\", tipo_alojamiento)\n",
    "\n",
    "            except NoSuchElementException:\n",
    "                tipo_alojamiento = None\n",
    "        \n",
    "    #CAPACIDAD\n",
    "        \n",
    "        try:\n",
    "            capacidad = driver.find_element(By.XPATH, nodo_capacidad).text\n",
    "            capacidad = int(re.sub(\"\\\\D\", \"\", capacidad))\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            try:\n",
    "                capacidad = driver.find_element(By.XPATH, nodo_capacidad2).text\n",
    "                capacidad = int(re.sub(\"\\\\D\", \"\", capacidad))\n",
    "\n",
    "            except NoSuchElementException:\n",
    "                capacidad = None \n",
    "        \n",
    "    #REVIEWS\n",
    "        \n",
    "        try:\n",
    "            reviews = driver.find_element(By.XPATH, nodo_reviews).text\n",
    "            reviews = re.search(r'·\\s*(\\d+)\\s+evaluaciones', reviews).group(1)\n",
    "            reviews = re.sub(r'\\D', '', reviews) \n",
    "            reviews = int(reviews) \n",
    "\n",
    "        except NoSuchElementException:\n",
    "            try:\n",
    "                reviews = driver.find_element(By.XPATH, nodo_reviews2).text\n",
    "                reviews = re.sub(r'\\D', '', reviews) \n",
    "                reviews = int(reviews) \n",
    "\n",
    "            except NoSuchElementException:\n",
    "                reviews = 0 \n",
    "                \n",
    "    #PUNTUACION\n",
    "        \n",
    "        try:\n",
    "            puntuacion = driver.find_element(By.XPATH, nodo_reviews).text\n",
    "            puntuacion = float(re.search(r'\\d+(,\\d+)?', puntuacion).group().replace(',', '.'))\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            try:\n",
    "                puntuacion = driver.find_element(By.XPATH, nodo_reviews).text\n",
    "                puntuacion = float(re.search(r'\\d+(,\\d+)?', puntuacion).group().replace(',', '.'))\n",
    "\n",
    "            except NoSuchElementException:\n",
    "                puntuacion = None \n",
    "                \n",
    "    #PRECIO\n",
    "        \n",
    "        try:\n",
    "            precio = driver.find_element(By.XPATH, nodo_precio).text\n",
    "            precio = int(re.sub(\"\\\\D\", \"\", precio))\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            precio = None \n",
    "                \n",
    "    #COORDENADAS\n",
    "        \n",
    "        try:\n",
    "            coordenadas = re.search(r'll=(-?\\d+\\.\\d+),(-?\\d+\\.\\d+)', driver.find_element(By.CSS_SELECTOR, nodo_coordenadas).get_attribute(\"href\"))\n",
    "            latitud = float(coordenadas.group(1))\n",
    "            longitud = float(coordenadas.group(2))\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            latitud = None\n",
    "            longitud = None\n",
    "            \n",
    "    #PERFIL HOST\n",
    "\n",
    "        try:\n",
    "            perfil_host = driver.find_element(By.XPATH, nodo_host).get_attribute(\"href\")\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            try:\n",
    "                perfil_host = driver.find_element(By.XPATH, nodo_host2).get_attribute(\"href\")\n",
    "\n",
    "            except NoSuchElementException:\n",
    "                try:\n",
    "                    perfil_host = driver.find_element(By.XPATH, nodo_host3).get_attribute(\"href\")\n",
    "\n",
    "                except NoSuchElementException:\n",
    "                    perfil_host = None \n",
    "                    \n",
    "    #ID_ROOM (PRIMARY KEY)\n",
    "    \n",
    "        id_room = re.search(r'/rooms/(\\d+)', url).group(1)\n",
    "        id_room = int(id_room)\n",
    "    \n",
    "    #ID_HOST (FOREIGN KEY)\n",
    "    \n",
    "        try:    \n",
    "            id_host = re.search(r'\\d+$', perfil_host).group()\n",
    "            id_host = int(id_host)\n",
    "            \n",
    "        except NoSuchElementException:\n",
    "            id_host = None\n",
    "                    \n",
    "    #URL\n",
    "        \n",
    "        url = re.sub(\"\\\\?.*\", \"\", url)\n",
    "        \n",
    "    #FECHA_EXTRACCION\n",
    "        \n",
    "        fecha_extraccion = pd.Timestamp.now().date()\n",
    "              \n",
    "    #UNIMOS LA INFORMACION\n",
    "        \n",
    "        data = {\n",
    "            \"titulo\": titulo,\n",
    "            \"localizacion\": localizacion,\n",
    "            \"tipo_alojamiento\": tipo_alojamiento,\n",
    "            \"capacidad\": capacidad,\n",
    "            \"latitud\": latitud,\n",
    "            \"longitud\": longitud,\n",
    "            \"reviews\": reviews,\n",
    "            \"puntuacion\": puntuacion,\n",
    "            \"precio\": precio,\n",
    "            \"id_room\": id_room,\n",
    "            \"id_host\": id_host,\n",
    "            \"perfil_host\": perfil_host,\n",
    "            \"url\": url,\n",
    "            \"fecha_extraccion\": fecha_extraccion\n",
    "        }\n",
    "        \n",
    "        df_room = pd.DataFrame(data, index=[0])\n",
    "        \n",
    "    \n",
    "    except Exception as e:\n",
    "        pass\n",
    "    \n",
    "    return df_room"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 43,
   "id": "62382621-5c78-4477-acb1-9b7494e3ff2e",
   "metadata": {
    "collapsed": true,
    "jupyter": {
     "outputs_hidden": true
    },
    "tags": []
   },
   "outputs": [
    {
     "ename": "NoSuchElementException",
     "evalue": "Message: no such element: Unable to locate element: {\"method\":\"xpath\",\"selector\":\"/html/body/div[9]/div/section/div/div/div[2]/div/div[2]/div/div[4]/button\"}\n  (Session info: headless chrome=116.0.5845.97); For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors#no-such-element-exception\nStacktrace:\nBacktrace:\n\tGetHandleVerifier [0x00DF1C53+49427]\n\t(No symbol) [0x00D85F41]\n\t(No symbol) [0x00C8C64D]\n\t(No symbol) [0x00CB9818]\n\t(No symbol) [0x00CB98DB]\n\t(No symbol) [0x00CE87D2]\n\t(No symbol) [0x00CD4A64]\n\t(No symbol) [0x00CE6F2A]\n\t(No symbol) [0x00CD4816]\n\t(No symbol) [0x00CB1127]\n\t(No symbol) [0x00CB22AD]\n\tGetHandleVerifier [0x01047149+2496009]\n\tGetHandleVerifier [0x0108D572+2783794]\n\tGetHandleVerifier [0x01087491+2758993]\n\tGetHandleVerifier [0x00E711D0+571024]\n\t(No symbol) [0x00D8F96A]\n\t(No symbol) [0x00D8BD88]\n\t(No symbol) [0x00D8BE6B]\n\t(No symbol) [0x00D7EA97]\n\tBaseThreadInitThunk [0x76D700C9+25]\n\tRtlGetAppContainerNamedObjectPath [0x77D17B1E+286]\n\tRtlGetAppContainerNamedObjectPath [0x77D17AEE+238]\n",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mNoSuchElementException\u001b[0m                    Traceback (most recent call last)",
      "\u001b[1;32mC:\\Users\\Public\\Documents\\Wondershare\\CreatorTemp\\ipykernel_2964\\452495391.py\u001b[0m in \u001b[0;36m<module>\u001b[1;34m\u001b[0m\n\u001b[0;32m      7\u001b[0m \u001b[0mtime\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0msleep\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;36m7\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m      8\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m----> 9\u001b[1;33m \u001b[0mdriver\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mfind_element\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mBy\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mXPATH\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;34m\"/html/body/div[9]/div/section/div/div/div[2]/div/div[2]/div/div[4]/button\"\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mclick\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m\u001b[0;32m     10\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m     11\u001b[0m \u001b[0mtime\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0msleep\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;36m3\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n",
      "\u001b[1;32m~\\anaconda3\\lib\\site-packages\\selenium\\webdriver\\remote\\webdriver.py\u001b[0m in \u001b[0;36mfind_element\u001b[1;34m(self, by, value)\u001b[0m\n\u001b[0;32m    738\u001b[0m             \u001b[0mvalue\u001b[0m \u001b[1;33m=\u001b[0m \u001b[1;34mf'[name=\"{value}\"]'\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    739\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m--> 740\u001b[1;33m         \u001b[1;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mexecute\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mCommand\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mFIND_ELEMENT\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;33m{\u001b[0m\u001b[1;34m\"using\"\u001b[0m\u001b[1;33m:\u001b[0m \u001b[0mby\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;34m\"value\"\u001b[0m\u001b[1;33m:\u001b[0m \u001b[0mvalue\u001b[0m\u001b[1;33m}\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;34m\"value\"\u001b[0m\u001b[1;33m]\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m\u001b[0;32m    741\u001b[0m \u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    742\u001b[0m     \u001b[1;32mdef\u001b[0m \u001b[0mfind_elements\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mself\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mby\u001b[0m\u001b[1;33m=\u001b[0m\u001b[0mBy\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mID\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mvalue\u001b[0m\u001b[1;33m:\u001b[0m \u001b[0mOptional\u001b[0m\u001b[1;33m[\u001b[0m\u001b[0mstr\u001b[0m\u001b[1;33m]\u001b[0m \u001b[1;33m=\u001b[0m \u001b[1;32mNone\u001b[0m\u001b[1;33m)\u001b[0m \u001b[1;33m->\u001b[0m \u001b[0mList\u001b[0m\u001b[1;33m[\u001b[0m\u001b[0mWebElement\u001b[0m\u001b[1;33m]\u001b[0m\u001b[1;33m:\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n",
      "\u001b[1;32m~\\anaconda3\\lib\\site-packages\\selenium\\webdriver\\remote\\webdriver.py\u001b[0m in \u001b[0;36mexecute\u001b[1;34m(self, driver_command, params)\u001b[0m\n\u001b[0;32m    344\u001b[0m         \u001b[0mresponse\u001b[0m \u001b[1;33m=\u001b[0m \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mcommand_executor\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mexecute\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mdriver_command\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mparams\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    345\u001b[0m         \u001b[1;32mif\u001b[0m \u001b[0mresponse\u001b[0m\u001b[1;33m:\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m--> 346\u001b[1;33m             \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0merror_handler\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mcheck_response\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mresponse\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m\u001b[0;32m    347\u001b[0m             \u001b[0mresponse\u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;34m\"value\"\u001b[0m\u001b[1;33m]\u001b[0m \u001b[1;33m=\u001b[0m \u001b[0mself\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0m_unwrap_value\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mresponse\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mget\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;34m\"value\"\u001b[0m\u001b[1;33m,\u001b[0m \u001b[1;32mNone\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    348\u001b[0m             \u001b[1;32mreturn\u001b[0m \u001b[0mresponse\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n",
      "\u001b[1;32m~\\anaconda3\\lib\\site-packages\\selenium\\webdriver\\remote\\errorhandler.py\u001b[0m in \u001b[0;36mcheck_response\u001b[1;34m(self, response)\u001b[0m\n\u001b[0;32m    243\u001b[0m                 \u001b[0malert_text\u001b[0m \u001b[1;33m=\u001b[0m \u001b[0mvalue\u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;34m\"alert\"\u001b[0m\u001b[1;33m]\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mget\u001b[0m\u001b[1;33m(\u001b[0m\u001b[1;34m\"text\"\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0;32m    244\u001b[0m             \u001b[1;32mraise\u001b[0m \u001b[0mexception_class\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mmessage\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mscreen\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mstacktrace\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0malert_text\u001b[0m\u001b[1;33m)\u001b[0m  \u001b[1;31m# type: ignore[call-arg]  # mypy is not smart enough here\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[1;32m--> 245\u001b[1;33m         \u001b[1;32mraise\u001b[0m \u001b[0mexception_class\u001b[0m\u001b[1;33m(\u001b[0m\u001b[0mmessage\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mscreen\u001b[0m\u001b[1;33m,\u001b[0m \u001b[0mstacktrace\u001b[0m\u001b[1;33m)\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m",
      "\u001b[1;31mNoSuchElementException\u001b[0m: Message: no such element: Unable to locate element: {\"method\":\"xpath\",\"selector\":\"/html/body/div[9]/div/section/div/div/div[2]/div/div[2]/div/div[4]/button\"}\n  (Session info: headless chrome=116.0.5845.97); For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors#no-such-element-exception\nStacktrace:\nBacktrace:\n\tGetHandleVerifier [0x00DF1C53+49427]\n\t(No symbol) [0x00D85F41]\n\t(No symbol) [0x00C8C64D]\n\t(No symbol) [0x00CB9818]\n\t(No symbol) [0x00CB98DB]\n\t(No symbol) [0x00CE87D2]\n\t(No symbol) [0x00CD4A64]\n\t(No symbol) [0x00CE6F2A]\n\t(No symbol) [0x00CD4816]\n\t(No symbol) [0x00CB1127]\n\t(No symbol) [0x00CB22AD]\n\tGetHandleVerifier [0x01047149+2496009]\n\tGetHandleVerifier [0x0108D572+2783794]\n\tGetHandleVerifier [0x01087491+2758993]\n\tGetHandleVerifier [0x00E711D0+571024]\n\t(No symbol) [0x00D8F96A]\n\t(No symbol) [0x00D8BD88]\n\t(No symbol) [0x00D8BE6B]\n\t(No symbol) [0x00D7EA97]\n\tBaseThreadInitThunk [0x76D700C9+25]\n\tRtlGetAppContainerNamedObjectPath [0x77D17B1E+286]\n\tRtlGetAppContainerNamedObjectPath [0x77D17AEE+238]\n"
     ]
    }
   ],
   "source": [
    "#BLOCK TRANSLATION \n",
    "\n",
    "url = \"https://www.airbnb.es/rooms/40911785?adults=1&category_tag=Tag%3A8678&children=0&enable_m3_private_room=true&infants=0&pets=0&photo_id=1169475226&check_in=2023-08-22&check_out=2023-08-27&source_impression_id=p3_1692525090_MxeN582L%2FoLyJz4l&previous_page_section_name=1000&federated_search_id=486da6af-b718-4875-bba7-4bf5001e01bc&_set_bev_on_new_domain=1692534067_OThiOTk3ZjVhNTgy\"\n",
    "\n",
    "driver.get(url)\n",
    "\n",
    "time.sleep(7)\n",
    "\n",
    "driver.find_element(By.XPATH, \"/html/body/div[9]/div/section/div/div/div[2]/div/div[2]/div/div[4]/button\").click()\n",
    "\n",
    "time.sleep(3)\n",
    "\n",
    "driver.find_element(By.XPATH, \"/html/body/div[10]/div/section/div/div/div[2]/div/div[2]/section[1]/div/ul/li/div/div[2]/button\").click()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 92,
   "id": "9c075fcb-f54a-41ce-a01e-3a4484c8a3d0",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ya extrajiste de la pag: 1 / 26 (3.8%)\n",
      "Ya extrajiste de la pag: 2 / 26 (7.7%)\n"
     ]
    }
   ],
   "source": [
    "#SECOND SCRAPING: ROOM\n",
    "\n",
    "df_room = pd.DataFrame()\n",
    "\n",
    "counter = 0\n",
    "total = len(df_link['link'])\n",
    "\n",
    "for url in df_link['link']:\n",
    "    extracted_data = extraer_datos(url)\n",
    "    df_room = pd.concat([df_room, extracted_data], ignore_index=True)\n",
    "    \n",
    "    counter += 1\n",
    "    print(f\"Ya extrajiste de la pag: {counter} / {total} ({round(counter/total*100, 1)}%)\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 76,
   "id": "e66d08a0-cd06-49ea-a0f4-49f62ce98853",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>titulo</th>\n",
       "      <th>localizacion</th>\n",
       "      <th>tipo_alojamiento</th>\n",
       "      <th>capacidad</th>\n",
       "      <th>latitud</th>\n",
       "      <th>longitud</th>\n",
       "      <th>reviews</th>\n",
       "      <th>puntuacion</th>\n",
       "      <th>precio</th>\n",
       "      <th>id_room</th>\n",
       "      <th>id_host</th>\n",
       "      <th>perfil_host</th>\n",
       "      <th>url</th>\n",
       "      <th>fecha_extraccion</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>penthouse atico Granada center</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Habitación en piso</td>\n",
       "      <td>1</td>\n",
       "      <td>37.180430</td>\n",
       "      <td>-3.597550</td>\n",
       "      <td>639</td>\n",
       "      <td>4.62</td>\n",
       "      <td>15.0</td>\n",
       "      <td>8100775</td>\n",
       "      <td>39235666</td>\n",
       "      <td>https://www.airbnb.es/users/show/39235666</td>\n",
       "      <td>https://www.airbnb.com/rooms/8100775</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Cuarto privado cerca de la estación de bus S</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Habitación en vivienda</td>\n",
       "      <td>1</td>\n",
       "      <td>37.196831</td>\n",
       "      <td>-3.613302</td>\n",
       "      <td>7</td>\n",
       "      <td>4.29</td>\n",
       "      <td>16.0</td>\n",
       "      <td>913043787077573890</td>\n",
       "      <td>186625735</td>\n",
       "      <td>https://www.airbnb.es/users/show/186625735</td>\n",
       "      <td>https://www.airbnb.com/rooms/913043787077573890</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Bonita habitación en Granada</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Habitación en piso</td>\n",
       "      <td>2</td>\n",
       "      <td>37.154050</td>\n",
       "      <td>-3.600720</td>\n",
       "      <td>22</td>\n",
       "      <td>4.82</td>\n",
       "      <td>17.0</td>\n",
       "      <td>547557717276771412</td>\n",
       "      <td>331377548</td>\n",
       "      <td>https://www.airbnb.es/users/show/331377548</td>\n",
       "      <td>https://www.airbnb.com/rooms/547557717276771412</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Encantador albergue en Granada</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Habitación compartida en hostal</td>\n",
       "      <td>6</td>\n",
       "      <td>37.180900</td>\n",
       "      <td>-3.599000</td>\n",
       "      <td>107</td>\n",
       "      <td>4.67</td>\n",
       "      <td>14.0</td>\n",
       "      <td>572281727450730591</td>\n",
       "      <td>53851091</td>\n",
       "      <td>https://www.airbnb.es/users/show/53851091</td>\n",
       "      <td>https://www.airbnb.com/rooms/572281727450730591</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1cama en habitación compartida 2</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Habitación compartida en piso</td>\n",
       "      <td>2</td>\n",
       "      <td>37.173180</td>\n",
       "      <td>-3.606393</td>\n",
       "      <td>2</td>\n",
       "      <td>NaN</td>\n",
       "      <td>10.0</td>\n",
       "      <td>953044771609741064</td>\n",
       "      <td>377456040</td>\n",
       "      <td>https://www.airbnb.es/users/show/377456040</td>\n",
       "      <td>https://www.airbnb.com/rooms/953044771609741064</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>772</th>\n",
       "      <td>My Granada Garden - Apartamento Orquídea</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Alojamiento entero: piso</td>\n",
       "      <td>7</td>\n",
       "      <td>37.185560</td>\n",
       "      <td>-3.599960</td>\n",
       "      <td>12</td>\n",
       "      <td>4.92</td>\n",
       "      <td>66.0</td>\n",
       "      <td>42831670</td>\n",
       "      <td>9572459</td>\n",
       "      <td>https://www.airbnb.es/users/show/9572459</td>\n",
       "      <td>https://www.airbnb.com/rooms/42831670</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>773</th>\n",
       "      <td>Habitación doble con baño y entrada independie...</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Habitación en suite con entrada independiente</td>\n",
       "      <td>1</td>\n",
       "      <td>37.186700</td>\n",
       "      <td>-3.588700</td>\n",
       "      <td>35</td>\n",
       "      <td>4.97</td>\n",
       "      <td>60.0</td>\n",
       "      <td>713729159517061746</td>\n",
       "      <td>57743150</td>\n",
       "      <td>https://www.airbnb.es/users/show/57743150</td>\n",
       "      <td>https://www.airbnb.com/rooms/713729159517061746</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>774</th>\n",
       "      <td>Cozy house near to the city center of Granada</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Alojamiento entero: vivienda</td>\n",
       "      <td>3</td>\n",
       "      <td>37.166610</td>\n",
       "      <td>-3.589000</td>\n",
       "      <td>8</td>\n",
       "      <td>4.88</td>\n",
       "      <td>61.0</td>\n",
       "      <td>650688348971162709</td>\n",
       "      <td>29807638</td>\n",
       "      <td>https://www.airbnb.es/users/show/29807638</td>\n",
       "      <td>https://www.airbnb.com/rooms/650688348971162709</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>775</th>\n",
       "      <td>Apartamento cristo de la yedra. Parking</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Alojamiento entero: piso</td>\n",
       "      <td>4</td>\n",
       "      <td>37.187300</td>\n",
       "      <td>-3.600600</td>\n",
       "      <td>243</td>\n",
       "      <td>4.47</td>\n",
       "      <td>62.0</td>\n",
       "      <td>24534128</td>\n",
       "      <td>79990245</td>\n",
       "      <td>https://www.airbnb.es/users/show/79990245</td>\n",
       "      <td>https://www.airbnb.com/rooms/24534128</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>776</th>\n",
       "      <td>MOLINOS APARTMENTS CITY CENTRE 1B</td>\n",
       "      <td>Granada, Andalucía, España</td>\n",
       "      <td>Alojamiento entero: piso</td>\n",
       "      <td>4</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>50</td>\n",
       "      <td>4.84</td>\n",
       "      <td>78.0</td>\n",
       "      <td>29186814</td>\n",
       "      <td>219867009</td>\n",
       "      <td>https://www.airbnb.es/users/show/219867009</td>\n",
       "      <td>https://www.airbnb.com/rooms/29186814</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>777 rows × 14 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                titulo  \\\n",
       "0                       penthouse atico Granada center   \n",
       "1         Cuarto privado cerca de la estación de bus S   \n",
       "2                         Bonita habitación en Granada   \n",
       "3                       Encantador albergue en Granada   \n",
       "4                     1cama en habitación compartida 2   \n",
       "..                                                 ...   \n",
       "772           My Granada Garden - Apartamento Orquídea   \n",
       "773  Habitación doble con baño y entrada independie...   \n",
       "774      Cozy house near to the city center of Granada   \n",
       "775            Apartamento cristo de la yedra. Parking   \n",
       "776                  MOLINOS APARTMENTS CITY CENTRE 1B   \n",
       "\n",
       "                   localizacion  \\\n",
       "0    Granada, Andalucía, España   \n",
       "1    Granada, Andalucía, España   \n",
       "2    Granada, Andalucía, España   \n",
       "3    Granada, Andalucía, España   \n",
       "4    Granada, Andalucía, España   \n",
       "..                          ...   \n",
       "772  Granada, Andalucía, España   \n",
       "773  Granada, Andalucía, España   \n",
       "774  Granada, Andalucía, España   \n",
       "775  Granada, Andalucía, España   \n",
       "776  Granada, Andalucía, España   \n",
       "\n",
       "                                  tipo_alojamiento  capacidad    latitud  \\\n",
       "0                               Habitación en piso          1  37.180430   \n",
       "1                           Habitación en vivienda          1  37.196831   \n",
       "2                               Habitación en piso          2  37.154050   \n",
       "3                  Habitación compartida en hostal          6  37.180900   \n",
       "4                    Habitación compartida en piso          2  37.173180   \n",
       "..                                             ...        ...        ...   \n",
       "772                       Alojamiento entero: piso          7  37.185560   \n",
       "773  Habitación en suite con entrada independiente          1  37.186700   \n",
       "774                   Alojamiento entero: vivienda          3  37.166610   \n",
       "775                       Alojamiento entero: piso          4  37.187300   \n",
       "776                       Alojamiento entero: piso          4        NaN   \n",
       "\n",
       "     longitud  reviews  puntuacion  precio             id_room    id_host  \\\n",
       "0   -3.597550      639        4.62    15.0             8100775   39235666   \n",
       "1   -3.613302        7        4.29    16.0  913043787077573890  186625735   \n",
       "2   -3.600720       22        4.82    17.0  547557717276771412  331377548   \n",
       "3   -3.599000      107        4.67    14.0  572281727450730591   53851091   \n",
       "4   -3.606393        2         NaN    10.0  953044771609741064  377456040   \n",
       "..        ...      ...         ...     ...                 ...        ...   \n",
       "772 -3.599960       12        4.92    66.0            42831670    9572459   \n",
       "773 -3.588700       35        4.97    60.0  713729159517061746   57743150   \n",
       "774 -3.589000        8        4.88    61.0  650688348971162709   29807638   \n",
       "775 -3.600600      243        4.47    62.0            24534128   79990245   \n",
       "776       NaN       50        4.84    78.0            29186814  219867009   \n",
       "\n",
       "                                    perfil_host  \\\n",
       "0     https://www.airbnb.es/users/show/39235666   \n",
       "1    https://www.airbnb.es/users/show/186625735   \n",
       "2    https://www.airbnb.es/users/show/331377548   \n",
       "3     https://www.airbnb.es/users/show/53851091   \n",
       "4    https://www.airbnb.es/users/show/377456040   \n",
       "..                                          ...   \n",
       "772    https://www.airbnb.es/users/show/9572459   \n",
       "773   https://www.airbnb.es/users/show/57743150   \n",
       "774   https://www.airbnb.es/users/show/29807638   \n",
       "775   https://www.airbnb.es/users/show/79990245   \n",
       "776  https://www.airbnb.es/users/show/219867009   \n",
       "\n",
       "                                                 url fecha_extraccion  \n",
       "0               https://www.airbnb.com/rooms/8100775       2023-08-21  \n",
       "1    https://www.airbnb.com/rooms/913043787077573890       2023-08-21  \n",
       "2    https://www.airbnb.com/rooms/547557717276771412       2023-08-21  \n",
       "3    https://www.airbnb.com/rooms/572281727450730591       2023-08-21  \n",
       "4    https://www.airbnb.com/rooms/953044771609741064       2023-08-21  \n",
       "..                                               ...              ...  \n",
       "772            https://www.airbnb.com/rooms/42831670       2023-08-21  \n",
       "773  https://www.airbnb.com/rooms/713729159517061746       2023-08-21  \n",
       "774  https://www.airbnb.com/rooms/650688348971162709       2023-08-21  \n",
       "775            https://www.airbnb.com/rooms/24534128       2023-08-21  \n",
       "776            https://www.airbnb.com/rooms/29186814       2023-08-21  \n",
       "\n",
       "[777 rows x 14 columns]"
      ]
     },
     "execution_count": 76,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#DELETE NaN AND DUPLICATE\n",
    "\n",
    "df_room = df_room.dropna(subset=['id_room'])\n",
    "\n",
    "df_room = df_room.drop_duplicates(subset=['id_room'], ignore_index=True)\n",
    "\n",
    "df_room"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 84,
   "id": "6aaaff05-70d1-4b2d-9196-ba62bfafb32f",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "#SAVE DATAFRAME\n",
    "\n",
    "df_room.to_csv(\"C:/Users/Pc/Desktop/df_room.csv\", index=False)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 167,
   "id": "8c8a4347-6519-42d0-9444-8df8f1a718b1",
   "metadata": {},
   "outputs": [],
   "source": [
    "#FUNCTION FOR THIRD SCRAPING: HOST\n",
    "\n",
    "def extraer_host(url):\n",
    "    \n",
    "    df_host = pd.DataFrame(columns = [\"nombre\",\n",
    "                                      \"evaluaciones\",\n",
    "                                      \"valoracion\",\n",
    "                                      \"experiencia_años\",\n",
    "                                      \"anuncios\",\n",
    "                                      \"id_host\",\n",
    "                                      \"url\",\n",
    "                                      \"fecha_extraccion\"])\n",
    "    \n",
    "    try:\n",
    "        \n",
    "    #ACCEDER A LA WEB, Y HACER SCROLL DOWN HACIA EL MAPA PARA QUE CARGE CORRECTAMENTE. \n",
    "    \n",
    "        driver.get(url)\n",
    "        \n",
    "        time.sleep(3)\n",
    "        \n",
    "    #NODOS\n",
    "        \n",
    "        nodo_nombre = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[1]/div[1]/div/div/section/div[1]/div[2]/h1/div/span\"       \n",
    "        nodo_evaluaciones = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[1]/div[1]/div/div/section/div[2]/div[1]/div/span[1]\"\n",
    "        nodo_valoracion = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[1]/div[1]/div/div/section/div[2]/div[2]/div/span[1]/div\"       \n",
    "        nodo_experiencia = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[1]/div[1]/div/div/section/div[2]/div[3]/div/span[1]\"\n",
    "        nodo_condicion = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[1]/div[1]/div/div/section/div[2]/div[3]/div/span[2]\"\n",
    "        nodo_anuncios = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[2]/div/div/div[7]/div/section/div[2]/div[1]\"\n",
    "        nodo_anuncios2 = \"/html/body/div[5]/div/div/div[1]/div/div[2]/div[1]/main/div/div/section/div/div[2]/div/div/div[6]/div/section/div[2]/div[1]\"\n",
    "\n",
    "    #NOMBRE\n",
    "        \n",
    "        try:\n",
    "            nombre = driver.find_element(By.XPATH, nodo_nombre).text\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            nombre = None\n",
    "        \n",
    "    #EVALUACIONES\n",
    "        \n",
    "        try:\n",
    "            evaluaciones = driver.find_element(By.XPATH, nodo_evaluaciones).text\n",
    "            evaluaciones = int(evaluaciones)\n",
    "        \n",
    "        except NoSuchElementException:\n",
    "            evaluaciones = None\n",
    "        \n",
    "    #VALORACION\n",
    "        \n",
    "        try:\n",
    "            valoracion = driver.find_element(By.XPATH, nodo_valoracion).text\n",
    "            valoracion = float(re.sub(\",\", \".\", valoracion))\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            valoracion = None\n",
    "        \n",
    "    #EXPERIENCIA\n",
    "        \n",
    "        try:    \n",
    "            condicion = driver.find_element(By.XPATH, nodo_condicion).text\n",
    "            condicion = int(condicion) #Ademas de descargar la condicion, creo un \"ValueError\" intencionado que provoque el primer Except\n",
    "\n",
    "        except ValueError as e:\n",
    "            if \"Año\" in str(condicion):\n",
    "                experiencia_años = driver.find_element(By.XPATH, nodo_experiencia).text\n",
    "                experiencia_años = int(experiencia_años)\n",
    "\n",
    "            else:\n",
    "                experiencia_años = 0\n",
    "\n",
    "        except NoSuchElementException:\n",
    "            experiencia_años = 0\n",
    "        \n",
    "    #ANUNCIOS\n",
    "    \n",
    "        try:    \n",
    "            anuncios = driver.find_element(By.XPATH, nodo_anuncios).text\n",
    "            anuncios = re.search(r'\\((.*?)\\)', anuncios).group(1)\n",
    "            anuncios = int(re.sub(r'\\D', '', anuncios))\n",
    "            \n",
    "        except NoSuchElementException:\n",
    "            try:\n",
    "                anuncios = driver.find_element(By.XPATH, nodo_anuncios2).text\n",
    "                anuncios = re.search(r'\\((.*?)\\)', anuncios).group(1)\n",
    "                anuncios = int(re.sub(r'\\D', '', anuncios))\n",
    "                \n",
    "            except NoSuchElementException:              \n",
    "                anuncios = None\n",
    "            \n",
    "    #ID_HOST (PRIMARY KEY)\n",
    "    \n",
    "        id_host = re.search(r'\\d+$', url).group()\n",
    "        id_host = int(id_host)\n",
    "        \n",
    "    #URL\n",
    "    \n",
    "        url = url\n",
    "    \n",
    "    #FECHA_EXTRACCION\n",
    "        \n",
    "        fecha_extraccion = pd.Timestamp.now().date()\n",
    "    \n",
    "    #UNIMOS LA INFORMACION\n",
    "        \n",
    "        data = {\n",
    "            \"nombre\": nombre,\n",
    "            \"evaluaciones\": evaluaciones,\n",
    "            \"valoracion\": valoracion,\n",
    "            \"experiencia_años\": experiencia_años,\n",
    "            \"anuncios\": anuncios,\n",
    "            \"id_host\": id_host,\n",
    "            \"url\": url,\n",
    "            \"fecha_extraccion\": fecha_extraccion\n",
    "        }\n",
    "\n",
    "\n",
    "        df_host = pd.DataFrame(data, index=[0])\n",
    "        \n",
    "    \n",
    "    except Exception as e:\n",
    "        pass\n",
    "    \n",
    "    return df_host\n",
    "        \n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 98,
   "id": "98e7e826-de5d-4da2-a7e1-81a89869df2c",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ya extrajiste de la pag: 1 / 777 (0.1%)\n",
      "Ya extrajiste de la pag: 2 / 777 (0.3%)\n"
     ]
    }
   ],
   "source": [
    "#THIRD SCRAPING: HOST\n",
    "\n",
    "df_host = pd.DataFrame()\n",
    "\n",
    "counter = 0\n",
    "total = len(df_room['perfil_host'])\n",
    "\n",
    "for url in df_room['perfil_host']:\n",
    "    extracted_data = extraer_host(url)\n",
    "    df_host = pd.concat([df_host, extracted_data], ignore_index=True)\n",
    "    \n",
    "    counter += 1\n",
    "    print(f\"Ya extrajiste de la pag: {counter} / {total} ({round(counter/total*100, 1)}%)\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 77,
   "id": "694c4aab-077f-4afd-8aa6-5c465808a5f7",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>nombre</th>\n",
       "      <th>evaluaciones</th>\n",
       "      <th>valoracion</th>\n",
       "      <th>experiencia_años</th>\n",
       "      <th>anuncios</th>\n",
       "      <th>id_host</th>\n",
       "      <th>url</th>\n",
       "      <th>fecha_extraccion</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Juan Pedro</td>\n",
       "      <td>2035.0</td>\n",
       "      <td>4.47</td>\n",
       "      <td>8</td>\n",
       "      <td>3.0</td>\n",
       "      <td>39235666</td>\n",
       "      <td>https://www.airbnb.es/users/show/39235666</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Alicia</td>\n",
       "      <td>24.0</td>\n",
       "      <td>4.58</td>\n",
       "      <td>0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>186625735</td>\n",
       "      <td>https://www.airbnb.es/users/show/186625735</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Fernando</td>\n",
       "      <td>23.0</td>\n",
       "      <td>4.83</td>\n",
       "      <td>4</td>\n",
       "      <td>1.0</td>\n",
       "      <td>331377548</td>\n",
       "      <td>https://www.airbnb.es/users/show/331377548</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Andrea</td>\n",
       "      <td>385.0</td>\n",
       "      <td>4.37</td>\n",
       "      <td>8</td>\n",
       "      <td>4.0</td>\n",
       "      <td>53851091</td>\n",
       "      <td>https://www.airbnb.es/users/show/53851091</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Marisolda</td>\n",
       "      <td>6.0</td>\n",
       "      <td>5.00</td>\n",
       "      <td>0</td>\n",
       "      <td>10.0</td>\n",
       "      <td>377456040</td>\n",
       "      <td>https://www.airbnb.es/users/show/377456040</td>\n",
       "      <td>2023-08-21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>462</th>\n",
       "      <td>Noor</td>\n",
       "      <td>331.0</td>\n",
       "      <td>4.78</td>\n",
       "      <td>2</td>\n",
       "      <td>3.0</td>\n",
       "      <td>129717408</td>\n",
       "      <td>https://www.airbnb.es/users/show/129717408</td>\n",
       "      <td>2023-08-22</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>463</th>\n",
       "      <td>María Elena</td>\n",
       "      <td>35.0</td>\n",
       "      <td>4.97</td>\n",
       "      <td>0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>57743150</td>\n",
       "      <td>https://www.airbnb.es/users/show/57743150</td>\n",
       "      <td>2023-08-22</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>464</th>\n",
       "      <td>Rafa</td>\n",
       "      <td>8.0</td>\n",
       "      <td>4.88</td>\n",
       "      <td>1</td>\n",
       "      <td>1.0</td>\n",
       "      <td>29807638</td>\n",
       "      <td>https://www.airbnb.es/users/show/29807638</td>\n",
       "      <td>2023-08-22</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>465</th>\n",
       "      <td>Roberto</td>\n",
       "      <td>342.0</td>\n",
       "      <td>4.61</td>\n",
       "      <td>6</td>\n",
       "      <td>3.0</td>\n",
       "      <td>79990245</td>\n",
       "      <td>https://www.airbnb.es/users/show/79990245</td>\n",
       "      <td>2023-08-22</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>466</th>\n",
       "      <td>David</td>\n",
       "      <td>405.0</td>\n",
       "      <td>4.88</td>\n",
       "      <td>5</td>\n",
       "      <td>7.0</td>\n",
       "      <td>219867009</td>\n",
       "      <td>https://www.airbnb.es/users/show/219867009</td>\n",
       "      <td>2023-08-22</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>467 rows × 8 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "          nombre  evaluaciones  valoracion  experiencia_años  anuncios  \\\n",
       "0     Juan Pedro        2035.0        4.47                 8       3.0   \n",
       "1         Alicia          24.0        4.58                 0       5.0   \n",
       "2       Fernando          23.0        4.83                 4       1.0   \n",
       "3         Andrea         385.0        4.37                 8       4.0   \n",
       "4      Marisolda           6.0        5.00                 0      10.0   \n",
       "..           ...           ...         ...               ...       ...   \n",
       "462         Noor         331.0        4.78                 2       3.0   \n",
       "463  María Elena          35.0        4.97                 0       1.0   \n",
       "464         Rafa           8.0        4.88                 1       1.0   \n",
       "465      Roberto         342.0        4.61                 6       3.0   \n",
       "466        David         405.0        4.88                 5       7.0   \n",
       "\n",
       "       id_host                                         url fecha_extraccion  \n",
       "0     39235666   https://www.airbnb.es/users/show/39235666       2023-08-21  \n",
       "1    186625735  https://www.airbnb.es/users/show/186625735       2023-08-21  \n",
       "2    331377548  https://www.airbnb.es/users/show/331377548       2023-08-21  \n",
       "3     53851091   https://www.airbnb.es/users/show/53851091       2023-08-21  \n",
       "4    377456040  https://www.airbnb.es/users/show/377456040       2023-08-21  \n",
       "..         ...                                         ...              ...  \n",
       "462  129717408  https://www.airbnb.es/users/show/129717408       2023-08-22  \n",
       "463   57743150   https://www.airbnb.es/users/show/57743150       2023-08-22  \n",
       "464   29807638   https://www.airbnb.es/users/show/29807638       2023-08-22  \n",
       "465   79990245   https://www.airbnb.es/users/show/79990245       2023-08-22  \n",
       "466  219867009  https://www.airbnb.es/users/show/219867009       2023-08-22  \n",
       "\n",
       "[467 rows x 8 columns]"
      ]
     },
     "execution_count": 77,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#DELETE DUPLICATE\n",
    "\n",
    "df_host = df_host.dropna(subset=['id_host'])\n",
    "\n",
    "df_host = df_host.drop_duplicates(subset=['id_host'], ignore_index=True)\n",
    "\n",
    "df_host"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 83,
   "id": "ad3eea43-da1c-468c-bf42-005c54006b86",
   "metadata": {},
   "outputs": [],
   "source": [
    "#SAVE DATAFRAME\n",
    "\n",
    "df_host.to_csv(\"C:/Users/Pc/Desktop/df_host.csv\", index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3ca7bbea-7c69-433d-a323-f52ff228e770",
   "metadata": {},
   "outputs": [],
   "source": [
    "# CLOSE THE WEBDRIVER\n",
    "\n",
    "driver.quit()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 86,
   "id": "bfbf5ee7-8700-4705-9c16-93f912485e48",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "#LOAD DATAFRAME\n",
    "\n",
    "df_link = pd.read_csv(\"C:/Users/Pc/Desktop/Pablo/Trabajo/Proyectos/Airbnb/Python/Dataframes/df_link.csv\")\n",
    "\n",
    "df_room = pd.read_csv(\"C:/Users/Pc/Desktop/Pablo/Trabajo/Proyectos/Airbnb/Python/Dataframes/df_room.csv\")\n",
    "\n",
    "df_host = pd.read_csv(\"C:/Users/Pc/Desktop/Pablo/Trabajo/Proyectos/Airbnb/Python/Dataframes/df_host.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 81,
   "id": "9d9f1d75-e7c8-4345-b9c5-4aa1efe60117",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "467"
      ]
     },
     "execution_count": 81,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#EXPORT DATAFRAMES TO MYSQL\n",
    "\n",
    "# Configura la conexión a MySQL (reemplaza los valores con los de tu configuración)\n",
    "usuario = \"root\"\n",
    "contraseña = \"variantedifusa96\"\n",
    "host = \"localhost\"\n",
    "puerto = 3306  \n",
    "base_de_datos = \"airbnb\"\n",
    "\n",
    "# Crea la URL de conexión\n",
    "url_conexion = f\"mysql+pymysql://{usuario}:{contraseña}@{host}:{puerto}/{base_de_datos}\"\n",
    "\n",
    "# Crea una instancia de la conexión a la base de datos\n",
    "engine = create_engine(url_conexion)\n",
    "\n",
    "# Exporta DataFrames a la base de datos\n",
    "df_link.to_sql(\"link\", con=engine, if_exists='replace', index=False)\n",
    "df_room.to_sql(\"room\", con=engine, if_exists='replace', index=False)\n",
    "df_host.to_sql(\"host\", con=engine, if_exists='replace', index=False)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 82,
   "id": "d4550509-32be-4a85-add1-f3e2341ff769",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "#CREATE PRIMARY KEYS AND FOREIGN KEYS\n",
    "\n",
    "#Configuration of Conexion\n",
    "config = {\n",
    "    'user': 'root',\n",
    "    'password': 'variantedifusa96',\n",
    "    'host': 'localhost',\n",
    "    'database': 'airbnb'\n",
    "}\n",
    "\n",
    "# Conexion\n",
    "conn = mysql.connector.connect(**config)\n",
    "cursor = conn.cursor()\n",
    "\n",
    "#PRIMARY KEYS\n",
    "    #Df_link\n",
    "sql_query = \"ALTER TABLE airbnb.link ADD PRIMARY KEY (link(255));\"\n",
    "cursor.execute(sql_query)\n",
    "    #Df_room\n",
    "sql_query = \"ALTER TABLE airbnb.room ADD PRIMARY KEY (id_room);\"\n",
    "cursor.execute(sql_query)\n",
    "    #Df_host\n",
    "sql_query = \"ALTER TABLE airbnb.host ADD PRIMARY KEY (id_host);\"\n",
    "cursor.execute(sql_query)\n",
    "    \n",
    "#FOREIGN KEYS\n",
    "    #Df_link\n",
    "sql_query = \"ALTER TABLE airbnb.link ADD FOREIGN KEY (id_room) REFERENCES room(id_room);\"\n",
    "cursor.execute(sql_query) \n",
    "    #Df_room\n",
    "sql_query = \"ALTER TABLE airbnb.room ADD FOREIGN KEY (id_host) REFERENCES host(id_host);\"\n",
    "cursor.execute(sql_query)    \n",
    "\n",
    "# Confirmar los cambios y cerrar la conexión\n",
    "conn.commit()\n",
    "cursor.close()\n",
    "conn.close()\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
